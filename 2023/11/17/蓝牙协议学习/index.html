<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="前言最近看到新出的星闪 有点兴趣 所以打算先从基础的蓝牙学起 顺便借此机会熟悉一下通讯以及协议相关的知识 本文用来记录关于蓝牙的一些研究 不做教学用途 蓝牙是什么蓝牙(Bluetooth)是一种无线通讯技术标准 用来让固定设备(手机 电脑等)以及移动设备(耳机 鼠标等)在短距离之间交换数据 形成个人局域网(PNA)其使用短波特高频 在2.4G到2.485G的ISM频段进行通讯蓝牙技术分为BR&amp;#x">
<meta property="og:type" content="article">
<meta property="og:title" content="蓝牙协议学习">
<meta property="og:url" content="http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="C12en">
<meta property="og:description" content="前言最近看到新出的星闪 有点兴趣 所以打算先从基础的蓝牙学起 顺便借此机会熟悉一下通讯以及协议相关的知识 本文用来记录关于蓝牙的一些研究 不做教学用途 蓝牙是什么蓝牙(Bluetooth)是一种无线通讯技术标准 用来让固定设备(手机 电脑等)以及移动设备(耳机 鼠标等)在短距离之间交换数据 形成个人局域网(PNA)其使用短波特高频 在2.4G到2.485G的ISM频段进行通讯蓝牙技术分为BR&amp;#x">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311171817663.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311171847386.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311291137757.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311172231870.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311172257393.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311221349945.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311221415162.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311221503589.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271040061.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271041735.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271046126.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271046736.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271048311.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271111184.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271128961.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271206767.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311291721022.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311291938341.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311291938053.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311291951658.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311292108088.jpg">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311292152051.jpg">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311292153115.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311292215515.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311301138474.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311301139780.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311301159234.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311301210463.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311301211842.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311301217368.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311301218695.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311302000354.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311302011543.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311302308336.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311302316448.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202312041053545.png">
<meta property="og:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202312111650536.png">
<meta property="article:published_time" content="2023-11-17T04:17:39.000Z">
<meta property="article:modified_time" content="2023-12-18T13:07:53.931Z">
<meta property="article:author" content="C12en">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311171817663.png">
    
    
      
        
          <link rel="shortcut icon" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202309142232390.png&#39;">
        
      
      
        
          <link rel="icon" type="image/png" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202309142232390.png&#39;" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202309142232390.png&#39;">
        
      
    
    <!-- title -->
    <title>蓝牙协议学习</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="C12en" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">categories</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/10/30/%E4%BC%AA%E9%9A%8F%E6%9C%BA%E6%95%B0%E6%8E%A8%E7%AE%97/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/&text=蓝牙协议学习"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/&title=蓝牙协议学习"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/&is_video=false&description=蓝牙协议学习"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=蓝牙协议学习&body=Check out this article: http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/&title=蓝牙协议学习"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/&title=蓝牙协议学习"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/&title=蓝牙协议学习"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/&title=蓝牙协议学习"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/&name=蓝牙协议学习&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/&t=蓝牙协议学习"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%93%9D%E7%89%99%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">2.</span> <span class="toc-text">蓝牙是什么</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%8E%E5%8A%9F%E8%80%97%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E6%A0%88"><span class="toc-number">3.</span> <span class="toc-text">低功耗蓝牙协议栈</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%A9%E7%90%86%E5%B1%82"><span class="toc-number">3.1.</span> <span class="toc-text">物理层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%93%BE%E8%B7%AF%E5%B1%82"><span class="toc-number">3.2.</span> <span class="toc-text">链路层</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%84%E9%A2%91%E7%8A%B6%E6%80%81"><span class="toc-number">3.2.1.</span> <span class="toc-text">射频状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F"><span class="toc-number">3.2.2.</span> <span class="toc-text">数据包格式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HCI%E5%B1%82"><span class="toc-number">3.3.</span> <span class="toc-text">HCI层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#L2CAP%E5%B1%82"><span class="toc-number">3.4.</span> <span class="toc-text">L2CAP层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SM%E5%B1%82"><span class="toc-number">3.5.</span> <span class="toc-text">SM层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ATT%E5%B1%82"><span class="toc-number">3.6.</span> <span class="toc-text">ATT层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GATT%E5%B1%82"><span class="toc-number">3.7.</span> <span class="toc-text">GATT层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GAP%E5%B1%82"><span class="toc-number">3.8.</span> <span class="toc-text">GAP层</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#BLE%E8%AE%BE%E5%A4%87%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">BLE设备工作流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E5%AF%B9%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.1.</span> <span class="toc-text">配对模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E5%AF%B9%E8%AE%A4%E8%AF%81"><span class="toc-number">4.2.</span> <span class="toc-text">配对认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%88%9D%E5%A7%8B%E5%AF%86%E9%92%A5"><span class="toc-number">4.2.1.</span> <span class="toc-text">生成初始密钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E9%93%BE%E8%B7%AF%E5%AF%86%E9%92%A5"><span class="toc-number">4.2.2.</span> <span class="toc-text">生成链路密钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8C%E6%96%B9%E8%AE%A4%E8%AF%81"><span class="toc-number">4.2.3.</span> <span class="toc-text">双方认证</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%83%A7%E5%BD%95canokey%E5%9B%BA%E4%BB%B6"><span class="toc-number">5.</span> <span class="toc-text">烧录canokey固件</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90"><span class="toc-number">6.</span> <span class="toc-text">抓包分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#bleak%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">7.</span> <span class="toc-text">bleak库的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E9%80%9A%E8%AE%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.1.</span> <span class="toc-text">基础通讯实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%AB%E6%8F%8F"><span class="toc-number">7.1.1.</span> <span class="toc-text">扫描</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E5%92%8C%E5%86%99%E5%85%A5"><span class="toc-number">7.1.2.</span> <span class="toc-text">读取和写入</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">8.</span> <span class="toc-text">漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2017-0785"><span class="toc-number">8.1.</span> <span class="toc-text">CVE-2017-0785</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-1"><span class="toc-number">8.1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E6%99%AE%E5%8F%8A"><span class="toc-number">8.1.2.</span> <span class="toc-text">背景普及</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SDP%E5%B1%82%E8%AF%A6%E8%A7%A3"><span class="toc-number">8.1.3.</span> <span class="toc-text">SDP层详解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">8.1.4.</span> <span class="toc-text">代码分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%93%E5%8F%96sdp%E5%8C%85"><span class="toc-number">8.1.5.</span> <span class="toc-text">抓取sdp包</span></a></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        蓝牙协议学习
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">C12en</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-11-17T04:17:39.000Z" class="dt-published" itemprop="datePublished">2023-11-17</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fa-solid fa-archive"></i>
        <a class="category-link" href="/categories/iot/">iot</a>
    </div>


      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/css/lightgallery.min.css" /><div class=".article-gallery"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近看到新出的星闪 有点兴趣 所以打算先从基础的蓝牙学起 顺便借此机会熟悉一下通讯以及协议相关的知识 本文用来记录关于蓝牙的一些研究 不做教学用途</p>
<h1 id="蓝牙是什么"><a href="#蓝牙是什么" class="headerlink" title="蓝牙是什么"></a>蓝牙是什么</h1><p>蓝牙(Bluetooth)是一种无线通讯技术标准 用来让固定设备(手机 电脑等)以及移动设备(耳机 鼠标等)在短距离之间交换数据 形成个人局域网(PNA)<br>其使用短波特高频 在2.4G到2.485G的ISM频段进行通讯<br>蓝牙技术分为BR&#x2F;EDR(基本速率&#x2F;增强数据率)和LE(低耗能)两种<br>前者是传统的蓝牙传输模式 拥有较高的传输速率 适用于需要较高宽带的应用 并且采用的是点对点的网络拓扑 即1对1通信<br>后者的功耗需求更低 提供了更快的连接 但是传输速率较小 适用于低功耗应用和设备 其采用点对点(1对1) 广播(1对多) 网格(多对多)等网络拓扑结构<br>二者是相互独立的传输模式 都有自己的协议栈和通讯方式 但是二者并非不可共存 我们称双模式设备为蓝牙双模设备<br>目前蓝牙由蓝牙技术联盟来负责维护技术标准 其并不负责制造蓝牙设备<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311171817663.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311171817663.png" alt="image.png"></a><br>上图为蓝牙各代版本的发展 自4.0以后 分为了BR&#x2F;EDR和LE两种模式<br>本文所要详细研究的BLE 并不等于蓝牙4.0 其只是4.0的一个部分</p>
<h1 id="低功耗蓝牙协议栈"><a href="#低功耗蓝牙协议栈" class="headerlink" title="低功耗蓝牙协议栈"></a>低功耗蓝牙协议栈</h1><p>先明白协议栈是一个什么东西<br>他是指网络通信中所有协议的一个集合  由多个层级组成<br>协议栈通常由三个部分组成 媒体 传输 应用<br>来看看TCP&#x2F;IP协议栈<br>其不仅包括TCP IP协议 还包括http ip dns tcp arp等协议<br>该协议有一个参考模型 所有的协议都归类到四个层级中 分别是链路层 网络层 传输层 应用层 每一层使用其下一层的协议来完成需求<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311171847386.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311171847386.png" alt="image.png"></a><br>具体的层级利用流程这里就不延申了 回到蓝牙协议栈 这里只介绍低功耗蓝牙BLE的协议栈<br>其也由三个部分组成 Host + HCI + Controller<br>主机(Host) 这部分由核心协议层(L2CAP、SM、ATT)和核心规范(GAP、GATT)构成<br>控制器(Controller) 分为Link Layer(链路层)和Physical Layer(物理层)<br>HCI 此部分定义了主机和控制器之间的通信标准 比如UART或者USB<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311291137757.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311291137757.png" alt="image.png"></a><br>接下来拆分各层进行概念的解析 更具体的深入随着后续的抓包分析进行</p>
<h2 id="物理层"><a href="#物理层" class="headerlink" title="物理层"></a>物理层</h2><p>BLE的物理层定义了无线电接收器&#x2F;发射器如何编码和解码传输的数据 以及应用的无线电的其他参数<br>其在2.4G到2.485G的免授权频段工作 采用40个信道 每个信道间隔2MHZ<br>分为广播信道和数据信道两个部分 广播频道只占用3个信道 固定为最后三个信道 用于发现设备 初始化连接以及广播数据<br>建立连接的设备 必须在同一信道 同一时间上才能传输数据<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311172231870.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311172231870.png" alt="image.png"></a></p>
<h2 id="链路层"><a href="#链路层" class="headerlink" title="链路层"></a>链路层</h2><p>该部分参考《core_v5.3.pdf》中的Part B: Link Layer Specification章节 即2662页起<br>下载地址: <a target="_blank" rel="noopener" href="https://www.bluetooth.com/zh-cn/specifications/specs/core-specification-5-3/">https://www.bluetooth.com/zh-cn/specifications/specs/core-specification-5-3/</a><br>链路层起到的作用很多 比如负责指定选择哪个射频通道进行通信 怎么确保数据的完整性 具体在哪个时间点把包发送出去等等 其是整个BLE协议栈的核心 不过链路层只负责数据的发送和接收 对于数据的解析则交给GAP和GATT</p>
<h3 id="射频状态"><a href="#射频状态" class="headerlink" title="射频状态"></a>射频状态</h3><p>共有五种射频状态 LL层可以控制设备处于这五种状态中的一种<br>待机 通告 扫描 初始化 连接<br>待机状态(Standby State) 此时既不发送数据 也不接收数据 设备此时最节能<br>通告状态(Advertising State) 处于此状态的设备称为”通告者” 会周期性的通过广播通道发送数据 可以由处于初始化状态以及扫描状态的设备接收到<br>扫描状态(Scanning State) 处于该状态的设备成为”扫描者” 可以通过广播通道接收数据<br>初始化状态(Initiating State) 与扫描状态相似 不过其只会监听特定设备的广播 并且在接收数据后 还会发起连接请求<br>连接状态(Connection State) 由通告状态和初始化状态自动切换 处于该状态的设备由两种角色 主设备和从设备</p>
<h3 id="数据包格式"><a href="#数据包格式" class="headerlink" title="数据包格式"></a>数据包格式</h3><p>在以往的学习过程中 复现过一个tddp报文的协议洞 同理 来看一下BLE的报文的基础格式<br>其包含4个字段 前导码 访问地址 协议数据单元(PDU) 循环冗余检验<br>在建立连接的过程中 使用广播通道(PDU) 传输数据用数据通道(PDU)<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311172257393.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311172257393.png" alt="image.png"></a><br>其中 广播报文和数据报文的格式也不一样<br>广播报头包括 广播报文类型(4字节) RFU(无实际作用 用来对齐字节 1字节) ChSel(无实际作用 用来对齐字节 1字节) TxAdd(发送地址类型 1字节) RxAdd(接收地址类型 1字节) Length(用来表示payload的长度 8字节)<br>数据报头包括 LLID(逻辑链路标识符 2字节)  NESN(下一个预期序列号 1字节) SN(序列号 1字节) MD(更多数据 1字节) CP(报文类型 4字节)RFU(保留 3字节) length(payload的长度 8字节) CTEinfo (连续音扩展 8字节)</p>
<h2 id="HCI层"><a href="#HCI层" class="headerlink" title="HCI层"></a>HCI层</h2><p>其为主机和控制器之间提供一组标准接口<br>主要的3个任务:<br>-将主机的命令下达给控制器<br>-控制器将事件传送给主机<br>-在连接通道上进行数据传输<br>这里的接口不单单指物理接口 也包括逻辑接口 逻辑接口定义了命令 事件 数据的封包格式 物理接口定义了主机和控制器之间如何传输数据</p>
<h2 id="L2CAP层"><a href="#L2CAP层" class="headerlink" title="L2CAP层"></a>L2CAP层</h2><p>该层功能较多 其支持数据的分割和重组 通道复用等等<br>其将PDU(协议数据单元)拆分成更小的片段 这样就可以在不同信道中传输 提高数据吞吐量以及更高的并发性<br>他允许低功耗蓝牙(BLE)在同一时间复用三条信道</p>
<h2 id="SM层"><a href="#SM层" class="headerlink" title="SM层"></a>SM层</h2><p>sm层的主要功能是负责ble连接建立 认证 解密等行为的安全性</p>
<h2 id="ATT层"><a href="#ATT层" class="headerlink" title="ATT层"></a>ATT层</h2><p>该层译文为数据交互协议<br>引入一个新概念 “属性”<br>可以认为一个属性就是一段数据 每一个属性都包含四个部分<br>1.句柄 用来标识属性的唯一<br>2.类型 用来存储属性的类型<br>3.值 用来存储属性的具体值<br>4.权限 用来规范执行操作的权限</p>
<h2 id="GATT层"><a href="#GATT层" class="headerlink" title="GATT层"></a>GATT层</h2><p>该层负责整合ATT层的属性 将其统筹为”服务”<br>一个BLE设备可以包含多个服务 一个服务可以包含多个特征 一个特征可以包含多个描述符<br>GATT用来规范特征中的内容</p>
<h2 id="GAP层"><a href="#GAP层" class="headerlink" title="GAP层"></a>GAP层</h2><p>该层定义了设备如何相互发现 连接 绑定以及描述了设备如何成为广播者和观察者<br>还定义了不同类型的地址来实现隐私性和可解析性<br>GAP有两个概念来定义设备的行为  模式和过程<br>模式指设备长时间进行的操作 例如广播模式 指设备正在进行广播 广播需要较长时间<br>过程指短时间内设备进行的操作 例如一个设备正在寻找广播 观察所需的时间较短<br>其一共定义了四个角色  广播者 观察者 外围设备 中央设备<br>这里区分是否外围的要素为 是否主动发起连接 主动的一方是中央设备</p>
<h1 id="BLE设备工作流程"><a href="#BLE设备工作流程" class="headerlink" title="BLE设备工作流程"></a>BLE设备工作流程</h1><h2 id="配对模式"><a href="#配对模式" class="headerlink" title="配对模式"></a>配对模式</h2><p>大体的流程分为<br>蓝牙启动-&gt;扫描设备-&gt;设备配对-&gt;数据传输<br>其中 蓝牙的设备配对可以分为四种<br>1.Numeric Comparison<br>配对双方都显示一个6位数字 用户核验数字一致后 即可配对成功<br>2.Just Works<br>用户看不到配对过程 主动发起连接即可配对 比如蓝牙耳机 开盖即可<br>3.Passkey Entry<br>与第一种较类似 不过是在配对目标(比如电脑)上输入本地设备上显示的6位数字<br>例如wallpaper手机端和电脑端的壁纸传输<br>4.Out of Band<br>通过其他途径交换配对信息 例如NTF</p>
<h2 id="配对认证"><a href="#配对认证" class="headerlink" title="配对认证"></a>配对认证</h2><p>蓝牙2.0协议之前确保配对过程安全的是凭借PIN码 PIN码长度可以为4到16位数字<br>在配对过程中 会根据PIN码来生成一个Linkkey 两个配对设备共享一个Linkkey 我们称这个行为为绑定 下次配对时 即可用Linkkey来认证<br>后续的协议凭借密钥交换来配对 分为生成初始密钥 生成链路密钥 双方认证三个过程</p>
<h3 id="生成初始密钥"><a href="#生成初始密钥" class="headerlink" title="生成初始密钥"></a>生成初始密钥</h3><p>首先引入几个概念 我们称提出通信要求的设备为主设备  被动进行通信的设备为从设备<br>初始密钥的长度为128bit 由k22算法生成 该算法需要三个参数<br>1.从设备的物理地址BR_ADDR 每一个蓝牙设备都会被分配一个唯一的48bit的BR_ADDR 主设备在生成密钥之前 通过询问的方式来获取从设备的蓝牙MAC地址<br>2.PIN码及其长度 PIN码是双方设备预先设定的<br>3.一个128bit的随机数 由主设备生成 以明文的方式发送给从设备<br>如果双方设备以上获取到三部分的值相同 因为采用的是相同的k22算法 所以生成的初始密钥(Kinit)也是一致的</p>
<h3 id="生成链路密钥"><a href="#生成链路密钥" class="headerlink" title="生成链路密钥"></a>生成链路密钥</h3><p>首先主设备生成128位随机数LK_RANDA 从设备也生成128位随机数LK_RANDB<br>主设备中 LK_RANDA和Kinit进行位比特逻辑异或运算 将结果发送给从设备<br>从设备中 LK_RANDB和Kinit进行位比特逻辑异或运算 将结果发送给主设备<br>此时主从设备中都具有相同的Kinit LK_RANDA LK_RANDB BR_ADDRA BR_ADDRB<br>此时利用E21算法将这些进行加密 并将结果异或得到Kab</p>
<h3 id="双方认证"><a href="#双方认证" class="headerlink" title="双方认证"></a>双方认证</h3><p>双方认证采用challenge-response方式<br>主设备A为应答方 从设备B为请求方<br>主设备A生成128bit的随机数AU_RANDA 以明文的形式传输给从设备B<br>双方利用E1算法 将各自得到的Kab AU_RANDA BD_ADDRB加密运算分别得到32位的SRESA和SRESB<br>B设备将SRESB发送给A A设备对比SRESA和SRESB 如果一致即认证通过<br>接下来交换双方的角色 重新进行一次认证</p>
<h1 id="烧录canokey固件"><a href="#烧录canokey固件" class="headerlink" title="烧录canokey固件"></a>烧录canokey固件</h1><p><strong>补:忙活了大半天 貌似这个固件不是用来搞蓝牙的…..被误导了  那就权当记录一下吧</strong><br>我买的蓝牙适配器是亿佰特E104-BT5040U 这一款是需要自己额外烧录固件才能使用的<br>那没办法了 接下来再学一手烧录固件<br>查阅了一些资料后 我选择CanoKey来刷入 <a target="_blank" rel="noopener" href="https://github.com/canokeys/canokey-nrf52">https://github.com/canokeys/canokey-nrf52</a><br>首先需要确保前置工具配置完全</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Prerequisites: 先决条件：</span><br><span class="line"></span><br><span class="line">CMake &gt;= 3.18</span><br><span class="line">GNU ARM Embedded Toolchain, downloaded from ARM</span><br><span class="line">GNU ARM 嵌入式工具链，从 ARM 下载</span><br><span class="line">git (used to generate embedding version string)</span><br><span class="line">git（用于生成嵌入版本字符串）</span><br><span class="line">python3 (used to generate UF2 format DFU file)</span><br><span class="line">python3（用于生成UF2格式的DFU文件）</span><br></pre></td></tr></table></figure>
<p>其他应该都安装过 这里提供GNU ARM的安装方式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt install gcc-arm-none-eabi</span><br></pre></td></tr></table></figure>
<p>那么接下来开始编译固件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/canokeys/canokey-nrf52.git</span><br><span class="line">cd canokey-nrf52/</span><br><span class="line">git submodule update --init --recursive</span><br><span class="line">mkdir build</span><br><span class="line">cd build</span><br><span class="line">cmake -DCROSS_COMPILE=/usr//bin/arm-none-eabi- \</span><br><span class="line">    -DCMAKE_TOOLCHAIN_FILE=../toolchain.cmake \</span><br><span class="line">    -DCMAKE_BUILD_TYPE=Release ..</span><br><span class="line">make canokey_flash.uf2</span><br></pre></td></tr></table></figure>
<p>执行cmake的时候会触发报错<br>照着报错信息下载nrf5_sdk_17.1.0_ddde560.zip(注意你购买的蓝牙适配器的芯片方案是否一致)<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311221349945.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311221349945.png" alt="image.png"></a><br>下载后解压到对应目录下即可<br>结果还是报错<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311221415162.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311221415162.png" alt="image.png"></a><br>于是换了一种思路</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/greenlsi/nrf5-sdk</span><br><span class="line">mv nrf5-sdk nRF5_SDK_17.1.0_ddde560</span><br></pre></td></tr></table></figure>
<p>然后再次执行cmake  成功<br>结果执行make的时候又报错了！！！！ 崩溃了<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311221503589.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311221503589.png" alt="image.png"></a><br>在对应报错文件首行加入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from __future__ import print_function</span><br></pre></td></tr></table></figure>
<p>终于 经过了千辛万苦 我们得到了canokey_flash.uf2  canokey.hex两个文件<br>接下来就是烧录固件了<br>这里选择nrf connect <a target="_blank" rel="noopener" href="https://www.nordicsemi.com/Products/Development-tools/nRF-Connect-for-Desktop/Download#infotabs">https://www.nordicsemi.com/Products/Development-tools/nRF-Connect-for-Desktop/Download#infotabs</a><br>安装后下载programmer<br>这里由于网络问题 导致直接在nrf connect中安装programmer失败<br>所以我们手动安装</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd C:\Users\22346\.nrfconnect-apps\local</span><br><span class="line">git clone https://github.com/greenlsi/nrf5-sdk</span><br><span class="line">git checkout v4.0.0</span><br><span class="line">npm install</span><br><span class="line">npm run watch</span><br></pre></td></tr></table></figure>
<p>随后就可以成功利用programmer刷取固件了<br>直接把我们编译出来的canokey.hex拖入进去 点击write<br>接下来的部分是初始化</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get install opensc pcscd pcsc-tools usbutils</span><br><span class="line">sudo pip3 install scriptor</span><br></pre></td></tr></table></figure>
<p>还有一个ccid 利用apt-get无法安装 在阿里云镜像站中找到了对应的安装包<br><a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/ubuntu/pool/universe/c/ccid/?spm=a2c6h.25603864.0.0.25adc813rsLGW7">https://mirrors.aliyun.com/ubuntu/pool/universe/c/ccid/?spm=a2c6h.25603864.0.0.25adc813rsLGW7</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar jxvf ccid_1.5.4.orig.tar.bz2</span><br><span class="line">cd ccid-1.5.4/</span><br><span class="line">sudo ./configure</span><br><span class="line">sudo make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<p>编译过程中遇到的第一个报错<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271040061.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271040061.png" alt="image.png"></a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt install flex</span><br></pre></td></tr></table></figure>
<p>第二个报错<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271041735.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271041735.png" alt="image.png"></a><br>找到对应的包 <a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/+source/pcsc-lite/2.0.1-1">https://launchpad.net/ubuntu/+source/pcsc-lite/2.0.1-1</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar jxvf pcsc-lite_2.0.1.orig.tar.bz2 pcsc-lite-2.0.1/</span><br><span class="line">cd pcsc-lite-2.0.1/</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<p>又遇到了报错<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271046126.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271046126.png" alt="image.png"></a><br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271046736.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271046736.png" alt="image.png"></a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt install libsystemd-dev libudev-dev</span><br></pre></td></tr></table></figure>
<p>还有报错 直接去提示的网址下载最新的安装包<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271048311.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271048311.png" alt="image.png"></a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tar -xf polkit-121.tar.gz</span><br></pre></td></tr></table></figure>
<p>看了下说明文档 要用meson来编译安装</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">BUILD INSTRUCTIONS</span><br><span class="line">==================</span><br><span class="line"></span><br><span class="line">**polkit** uses [meson build system](https://mesonbuild.com/) for configuration with *ninja* as backend and *gcc* as compiler.  </span><br><span class="line">To configure and compile your copy of polkit tarball, simply follow meson build instructions in the following manner:</span><br><span class="line">$ meson setup [[-D option]...] target_directory</span><br><span class="line">$ meson compile -C target_directory</span><br><span class="line"># meson install -C target_directory</span><br><span class="line"></span><br><span class="line">List of available configuration options can be obtained with `meson configure` command.</span><br></pre></td></tr></table></figure>
<p>接下来开始编译</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt install meson</span><br><span class="line">sudo apt install aptitude</span><br><span class="line">sudo aptitude install duktape-dev</span><br><span class="line">sudo apt install libpam0g-dev</span><br><span class="line">sudo apt install libdbus-1-dev</span><br><span class="line">sudo apt install libpthread-stubs0-dev</span><br><span class="line">sudo apt install libgirepository1.0-dev</span><br><span class="line">meson setup ./polkit-v.121/</span><br><span class="line">meson complie</span><br><span class="line">cd  ./polkit-v.121/</span><br><span class="line">meson install</span><br></pre></td></tr></table></figure>
<p>然后我们回到pcsc-lite的编译 可以成功运行下去了<br>回到ccid的编译 又又又遇到报错了<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271111184.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271111184.png" alt="image.png"></a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt install libusb-1.0-0-dev</span><br></pre></td></tr></table></figure>
<p>随后终于可以成功编译<br>接着将我们烧录好固件的蓝牙适配器接入电脑<br>使用lsusb查看是否检测到Clay Logic usb<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271128961.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271128961.png" alt="image.png"></a><br>(然后运行sudo pcsc_scan  发现还是一堆报错 忙活半天还是无法解决 最后还把虚拟机干坏了<br>于是选择更换了ubuntu22 编译ccid的时候几乎畅通无阻<br>重新运行lsusb 没有发现clay logic usb<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271206767.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311271206767.png" alt="image.png"></a><br>点击vmware右下角的clay logic usb 点击和主机断开连接后<br>就可以检测到了<br>随后使用sudo pcsc_scan连接 切换另外一个终端</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd canokey-nrf52/utils</span><br><span class="line">sudo ./device-config-init.sh &#x27;Canokeys Canokey [OpenPGP PIV OATH] (123456) 00 00&#x27;</span><br></pre></td></tr></table></figure>
<h1 id="抓包分析"><a href="#抓包分析" class="headerlink" title="抓包分析"></a>抓包分析</h1><p>这里我选择的设备是 E104-BT5032U 芯片采用的是nRF52832<br>首先安装wireshark 这里就不介绍了 注意要顺便装上usbPcap插件<br>根据产品提供的文档 下载对应的sniffer版本 <a target="_blank" rel="noopener" href="https://www.ebyte.com/product-view-news.html?id=1745">https://www.ebyte.com/product-view-news.html?id=1745</a><br>将excap文件夹内的所有文件复制到wireshark的对应文件夹中<br>随后将Profile_nRF_Sniffer_Bluetooth_LE文件夹中的内容复制到wireshark的profiles中<br>随后将设备插入 此时应该能发现对应的接口<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311291721022.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311291721022.png" alt="image.png"></a><br>此外还需要打开 视图-&gt;接口工具栏-&gt;nRF sniffer for bluetooth<br>此举是为了便于我们选择设备<br>我们直接点击过滤器 此时接收到了大量的包 在刚刚打开的栏中 我们可以选择特定的设备接收<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311291938341.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311291938341.png" alt="image.png"></a><br>点开Device后 可以注意到前面的dBm<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311291938053.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311291938053.png" alt="image.png"></a><br>其是用来衡量蓝牙发送功率或者接收功率的对数单位<br>一个负数的dBm表示相对于一个毫瓦的参考功率而言的衰减<br>也就是说-80dBm的信号会强于-100dBm<br>由于抓包的地点选在了宿舍 为了减少其他学生的BLE设备带来的影响 这里在选用接口之前先对rssi进行限制<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311291951658.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311291951658.png" alt="image.png"></a><br>在开始接下来的操作之前 要明白所购买的E104-BT5032U到底是一个什么样的设备<br>在我刚开始 我一直误以为 是通过这个设备发送包来和主机通讯 然后我们使用wireshark来抓包<br>但是实际上 可以把其看作一个从设备 接收各个主设备的包 然后我们利用wireshark可以查看这些包<br>所以我们还需要在其他平台上对于wireshark所监听的设备 进行发包等操作<br>这样就可以通过wireshark来查看这些包的内容 从而达到我们更进一步分析的目的 至于想要搭建一个发包的设备  那就是后话了<br>这里我选择我的手机 REDMI K50PRO来进行抓包<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311292108088.jpg" title="Screenshot_2023-11-29-21-08-23-845_no.nordicsemi..jpg" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311292108088.jpg" alt="Screenshot_2023-11-29-21-08-23-845_no.nordicsemi..jpg"></a><br>这里先把理论知识来结合一下实际温习一遍<br>在上文的学习中 我们得知了一个设备包含多种服务 而服务包含多种特征 特征又包含多种属性<br>以上图举例 Generic Access就是一个服务 以及最后的Unknown Service也是<br>前者被识别出来了服务名字 说明其是一个官方定义的服务 而后者无法被识别说明是小米的私有服务 官方服务可以通过查询来获取其作用<br><a target="_blank" rel="noopener" href="https://www.bluetooth.com/wp-content/uploads/Files/Specification/Assigned_Numbers.pdf?id=89">https://www.bluetooth.com/wp-content/uploads/Files/Specification/Assigned_Numbers.pdf?id=89</a><br>我们向手机发送请求 请求返回设备名称<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311292152051.jpg" title="Screenshot_2023-11-29-21-51-48-448_no.nordicsemi..jpg" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311292152051.jpg" alt="Screenshot_2023-11-29-21-51-48-448_no.nordicsemi..jpg"></a><br>来到wireshark 通过检索找到请求包以及返回包<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311292153115.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311292153115.png" alt="image.png"></a><br>先来看请求包 走的是物理通道<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311292215515.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311292215515.png" alt="image.png"></a><br>根据上文 其应该由前导码 访问地址 协议数据单元 循环冗余检验四个部分组成<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311301138474.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311301138474.png" alt="image.png"></a><br>图中黑框部分就是数据包 前面是nrf connect发包的一些参数<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311301139780.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311301139780.png" alt="image.png"></a><br>前导码是一个01交替的固定序列 在LE 1M PHY上为8bit<br>LE 2M PHY上为16bit 二者是不同的物理层传输方式 区别在于传输速率<br>通常为0x55或者是0xaa 但是这里我并没有找到前导码 位于包头的是访问地址<br>这里查阅了文档也没提及这一点 观察了其他的LL层报文 也都没有出现前导码<br>个人猜测是与我们使用nrf connect发包有关系 这个疑问得到后续的使用项目发包再来解决<br>访问地址用来指明A和B设备之间进行传输<br>但是你可以发现很多包的访问地址都是一样的 0x8e89bed6<br>此为广告物理通道数据包固定的访问地址<br>广告物理通道PDU仍然走的是物理通道 但是其是用于广播 扫描 发起连接<br>广告物理通道的PDU拥有16bit的标头<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311301159234.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311301159234.png" alt="image.png"></a><br>其拆分成各部分如上图所示<br>我们抓包得到的两个字节为 0xc30c<br>0x0c是length这部分 那么0xc3就是前面的五个部分<br>将其拆分成二进制可以得到</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1 1 0 0 0011</span><br></pre></td></tr></table></figure>
<p>观察wireshark解析出来的各个部分 和我们自己解析的不一样<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311301210463.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311301210463.png" alt="image.png"></a><br>联想到前面的访问地址在数据包中的形式 所以这里应该是采用了小端序存储<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311301211842.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311301211842.png" alt="image.png"></a><br>PDU TYPE 为0011 应对者SCAN_REQ 并且格式为LE 1M<br>接下来 显然红框的部分就是payload<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311301217368.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311301217368.png" alt="image.png"></a><br>一共是12字节 也印证了前面标头中的length没错<br>payload的内容定义了扫描设备的MAC地址以及广播设备的MAC地址<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311301218695.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311301218695.png" alt="image.png"></a><br>后面的三字节 即为crc校验码 用来确保数据传输过程中的完整性</p>
<h1 id="bleak库的使用"><a href="#bleak库的使用" class="headerlink" title="bleak库的使用"></a>bleak库的使用</h1><p>接下来尝试使用python的bleak库来和蓝牙设备进行通讯 此举为了便于我们后面阅读蓝牙安全相关的论文或者是复现cve漏洞 <a target="_blank" rel="noopener" href="https://github.com/hbldh/bleak">https://github.com/hbldh/bleak</a><br>以下代码示例如非特殊说明 均在windows11平台下进行<br>同时 官方的代码示例中 会使用asyncio库进行异步编程 由于我的开发能力几乎没有 所以会借助这次机会 了解了解 下文中会偶尔穿插一些异步编程的理解<br>安装库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip install bleak</span><br></pre></td></tr></table></figure>
<h2 id="基础通讯实现"><a href="#基础通讯实现" class="headerlink" title="基础通讯实现"></a>基础通讯实现</h2><h3 id="扫描"><a href="#扫描" class="headerlink" title="扫描"></a>扫描</h3><p>先来尝试扫描可连接的蓝牙设备</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import asyncio</span><br><span class="line">from bleak import BleakScanner</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">async def main():</span><br><span class="line">    devices = await BleakScanner.discover()</span><br><span class="line">    for d in devices:</span><br><span class="line">        print(d)</span><br><span class="line"></span><br><span class="line">asyncio.run(main())</span><br></pre></td></tr></table></figure>
<p>可以看到扫描到了一些设备<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311302000354.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311302000354.png" alt="image.png"></a><br>前面的是设备的MAC地址 后面的是名称 虽然我们前面提到 设备的设备地址是唯一的<br>其中设备地址有两种形式 公共设备地址以及随机设备地址<br>公共设备地址是需要向IEEE申请的 同时需要花钱 但具有唯一性<br>而随机设备地址在设备启动后随机生成<br>在现如今不断增加的蓝牙设备 尤其是大量的BLE设备 显然前者的弊端是比较大的 所以大多数采用的是随机设备地址<br>这里以上图中的蓝牙键盘 Kzzi-K75为例 在第一次扫描的过程中 其MAC地址为DD:BB:CF:F4:BD:D9<br>接下来我们关闭该设备 随后再次打开 再次扫描一下试试<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311302011543.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311302011543.png" alt="image.png"></a><br>可以发现此时变更为了F1:4E:33:18:EC:D5<br>接下来我们尝试使用python脚本来实现和上面用nrf connect工具获取设备名称的操作</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">async def get_devideinfo(address):</span><br><span class="line">    async with BleakClient(address) as client:</span><br><span class="line">        print(&quot;成功连接到蓝牙设备&quot;)</span><br><span class="line">        services = client.services</span><br><span class="line">        for s in services:</span><br><span class="line">            print(&quot;服务uuid:&quot;,s.uuid)</span><br><span class="line">            for c in s.characteristics:</span><br><span class="line">                print(c)</span><br></pre></td></tr></table></figure>
<p>这里使用BleakClient构造函数 以address为参数  创建了一个client对象<br>client此时是一个客户端实例 可以将其理解为一个主设备 用于连接其他设备 以及发起通讯<br>通过上述代码 我们可以获取到address对应的设备的服务及其特征<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311302308336.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311302308336.png" alt="image.png"></a><br>还可以通过输出c.properties来查看特征值的权限<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311302316448.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202311302316448.png" alt="image.png"></a></p>
<h3 id="读取和写入"><a href="#读取和写入" class="headerlink" title="读取和写入"></a>读取和写入</h3><p>接下来 我们将对特征值动手 学习使用write_gatt_char()和read_gatt_char()两个方法<br>我们前面提到过ATT层的核心就是属性<br>属性由 句柄 类型 值 权限这四个部分组成<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202312041053545.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202312041053545.png" alt="image.png"></a><br>句柄是一个2字节的十六进制码 在系统初始化时为0x0001 逐步增加1 最高到0xffff<br>可以把其看作一个指向属性的指针 通过句柄可以访问到对应的属性<br>类型是用来区分当前属性是服务还是特征 具体的表现形式是uuid<br>Ble的属性类型一共有四大类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Primary Service（首要服务项）</span><br><span class="line">Secondary Service（次要服务项）</span><br><span class="line">Include（包含服务项）</span><br><span class="line">Characteristic（特征值）</span><br></pre></td></tr></table></figure>
<p>uuid中的第三和第四字节对于属性类型进行了标注<br>以下列这个uuid为例 00002a00-0000-1000-8000-00805f9b34fb<br>其第三第四字节为0x2a00<br>根据下列表格判断得到 为特征值类型</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x1800 – 0x26FF ：服务项类型</span><br><span class="line">0x2700 – 0x27FF ：单位</span><br><span class="line">0x2800 – 0x28FF ：属性类型</span><br><span class="line">0x2900 – 0x29FF ：描述符类型</span><br><span class="line">0x2A00 – 0x7FFF ：特征值类型</span><br></pre></td></tr></table></figure>
<p>值则用来存放属性的内容 其需要一定的内存空间 操控属性值就是对这块内容空间进行更改<br>属性权限包括四种 访问权限 加密权限 认证权限 授权权限<br>了解了这些前置知识 再来观摩观摩官方给出的几个bleak库例子代码<br><a target="_blank" rel="noopener" href="https://github.com/hbldh/bleak/blob/develop/examples/sensortag.py">https://github.com/hbldh/bleak/blob/develop/examples/sensortag.py</a><br>来看68行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">uuid16_lookup = &#123;v: normalize_uuid_16(k) for k, v in uuid16_dict.items()&#125;</span><br></pre></td></tr></table></figure>
<h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><h2 id="CVE-2017-0785"><a href="#CVE-2017-0785" class="headerlink" title="CVE-2017-0785"></a>CVE-2017-0785</h2><h3 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h3><p>该漏洞的核心在于BlueDroid和Fluoride这两个适用于安卓操作系统的蓝牙协议栈<br>总体的理解难度比较大 包含了比较多的新知识</p>
<h3 id="背景普及"><a href="#背景普及" class="headerlink" title="背景普及"></a>背景普及</h3><p>我们上文中仅对于低功耗蓝牙协议栈进行了普及 但是我们本次复现的漏洞是关于经典蓝牙的 所以这里先对于漏洞的发生层SDP 进行一些简单的介绍以及了解经典蓝牙的协议栈<br><a target="_blank" rel="noopener" href="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202312111650536.png" title="image.png" class="gallery-item"><img src="https://blog-1259781238.cos.ap-nanjing.myqcloud.com/202312111650536.png" alt="image.png"></a><br>上图中 红色部分是经典蓝牙协议栈独有的 绿色部分是低功耗蓝牙所独有的 蓝色部分为公共部分<br>但是经典蓝牙也可以拥有部分绿色的特性<br>SDP层为服务发现协议(SERVICE DISCOVERY PROTOCOL) 为应用程序提供方法发现哪些服务可用 并确认这些服务的特征<br>你是否还记得前面学习的抓包 我们抓取的是利用nrf connect for moblie来向ble设备发包<br>通过wireshark抓取到的就是一个request pdu和一个response pdu<br>sdp也是同理 其实际上就是定义一个client如何找到server提供的服务<br>client先向server发送一个request pdu 等待server相应后返回response pdu<br>来观察一下两种pdu的构造</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Bluetooth SDP Protocol</span><br><span class="line">        PDU: Service Search Attribute Request (0x06)</span><br><span class="line">        Transaction Id: 0x0000</span><br><span class="line">        Parameter Length: 15</span><br><span class="line">        Service Search Pattern: Public Browse Group</span><br><span class="line">        Maximum Attribute Byte Count: 65535</span><br><span class="line">        Attribute ID List</span><br><span class="line">        Continuation State: no (00)</span><br></pre></td></tr></table></figure>
<p>先是request pdu  有两个比较重要的参数Maximum Attribute Byte Count和Continuation State<br>前者用于限制response pdu返回的数据大小<br>比如这里为65535 即不得超过对应字节 来结合下面这个response pdu</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Bluetooth SDP Protocol</span><br><span class="line">        PDU: Service Search Attribute Response (0x07)</span><br><span class="line">        Transaction Id: 0x0000</span><br><span class="line">        Parameter Length: 667</span><br><span class="line">        Attribute List Byte Count: 662</span><br><span class="line">        Data Fragment</span><br><span class="line">        Continuation State: yes (02 96)</span><br><span class="line">            Continuation State Length: 2</span><br><span class="line">            Continuation State Value</span><br></pre></td></tr></table></figure>
<p>Attribute List Byte Count标识了response pdu包含的数据大小 为662<br>Attribute List Byte Count的大小不得超过Maximum Attribute Byte Count所定义的<br>如果超过了 就会对response pdu进行分段 随后利用Continuation State进行传输<br>这里的分段大小是由server自己决定的 比如上述的两个pdu Attribute List Byte Count就是662 并没有将Maximum Attribute Byte Count全部分割<br>目前手头还没有设备能够抓取sdp层的包 所以这里先使用其他文章中的包来分析<br>Continuation State包含两个部分 InfoLength和Continuation Information<br>前者用来标识后者的长度 最大值为0x10<br>后者通过response pdu发回给client 随后client会将其放到下一个request pdu中 发送给server 从而再作出分段的决策 以此来往复<br>但是在实际的过程中 造成分段的并不只有上述这一个原因<br>L2CAP的Maximum Transmission Unit参数仍然会限制数据大小 从而造成分段</p>
<h3 id="SDP层详解"><a href="#SDP层详解" class="headerlink" title="SDP层详解"></a>SDP层详解</h3><h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><p>需要进一步了解Continuation Information在Android中是如何定义的 就需要我们来阅读源码<br><a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/system/bt/+/refs/tags/android-8.0.0_r1/stack/sdp/sdpint.h">https://android.googlesource.com/platform/system/bt/+/refs/tags/android-8.0.0_r1/stack/sdp/sdpint.h</a> 中的第200行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">    #if (SDP_SERVER_ENABLED == TRUE)</span><br><span class="line">  uint16_t cont_offset;     /* Continuation state data in the server response */</span><br><span class="line">  tSDP_CONT_INFO cont_info; /* structure to hold continuation information for</span><br><span class="line">                               the server response */</span><br><span class="line">#endif                      /* SDP_SERVER_ENABLED == TRUE */</span><br><span class="line">&#125; tCONN_CB;</span><br></pre></td></tr></table></figure>
<p>其中的 cont_offset起到了关键的作用 从注释中可以得知 其是用来指示客户端在请求继续传输时 从响应数据的哪个位置开始获取后续的数据<br>也就是我们上文说到的数据分段的时候 其负责给server索引分段的数据<br>根据pdu的不同 可以分为两种情况<br>第一类情形是使用SDP_SERVICE_SEARCH_REQ&#x2F;RSP PDU时 即服务搜索请求和服务搜索响应<br>此时的数据单位称之为数据项 如果上一个pdu已经传输了20数据项 那么cont_offset的值就是20<br>第二类情形是使用SDP_SERVICE_ATTR_REQ&#x2F;RSP 或 SDP_SERVICE_SEARCH_ATTR_REQ&#x2F;RSP 时 即服务属性请求&#x2F;响应 服务属性搜索请求&#x2F;响应<br>区别于前者 数据的单位由数据项变成了字节 其代表的是已经传输的数据总和  比如如果为662 说明前面传输的分段数据大小为662字节<br>总是纸上谈兵可不能理解清楚 我们来尝试利用wireshark抓一个sdp包来看看</p>
<h3 id="抓取sdp包"><a href="#抓取sdp包" class="headerlink" title="抓取sdp包"></a>抓取sdp包</h3></div><script src="https://cdn.jsdelivr.net/lightgallery.js/1.0.1/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script>
  </div>
</article>

    <div class="blog-post-comments">
        <div id="disqus_thread">
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
    </div>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a href="/categories/">categories</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%93%9D%E7%89%99%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">2.</span> <span class="toc-text">蓝牙是什么</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%8E%E5%8A%9F%E8%80%97%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E6%A0%88"><span class="toc-number">3.</span> <span class="toc-text">低功耗蓝牙协议栈</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%A9%E7%90%86%E5%B1%82"><span class="toc-number">3.1.</span> <span class="toc-text">物理层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%93%BE%E8%B7%AF%E5%B1%82"><span class="toc-number">3.2.</span> <span class="toc-text">链路层</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%84%E9%A2%91%E7%8A%B6%E6%80%81"><span class="toc-number">3.2.1.</span> <span class="toc-text">射频状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%8C%85%E6%A0%BC%E5%BC%8F"><span class="toc-number">3.2.2.</span> <span class="toc-text">数据包格式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HCI%E5%B1%82"><span class="toc-number">3.3.</span> <span class="toc-text">HCI层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#L2CAP%E5%B1%82"><span class="toc-number">3.4.</span> <span class="toc-text">L2CAP层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SM%E5%B1%82"><span class="toc-number">3.5.</span> <span class="toc-text">SM层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ATT%E5%B1%82"><span class="toc-number">3.6.</span> <span class="toc-text">ATT层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GATT%E5%B1%82"><span class="toc-number">3.7.</span> <span class="toc-text">GATT层</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GAP%E5%B1%82"><span class="toc-number">3.8.</span> <span class="toc-text">GAP层</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#BLE%E8%AE%BE%E5%A4%87%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">4.</span> <span class="toc-text">BLE设备工作流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E5%AF%B9%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.1.</span> <span class="toc-text">配对模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E5%AF%B9%E8%AE%A4%E8%AF%81"><span class="toc-number">4.2.</span> <span class="toc-text">配对认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%88%9D%E5%A7%8B%E5%AF%86%E9%92%A5"><span class="toc-number">4.2.1.</span> <span class="toc-text">生成初始密钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E9%93%BE%E8%B7%AF%E5%AF%86%E9%92%A5"><span class="toc-number">4.2.2.</span> <span class="toc-text">生成链路密钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8C%E6%96%B9%E8%AE%A4%E8%AF%81"><span class="toc-number">4.2.3.</span> <span class="toc-text">双方认证</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%83%A7%E5%BD%95canokey%E5%9B%BA%E4%BB%B6"><span class="toc-number">5.</span> <span class="toc-text">烧录canokey固件</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90"><span class="toc-number">6.</span> <span class="toc-text">抓包分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#bleak%E5%BA%93%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">7.</span> <span class="toc-text">bleak库的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E9%80%9A%E8%AE%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">7.1.</span> <span class="toc-text">基础通讯实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%AB%E6%8F%8F"><span class="toc-number">7.1.1.</span> <span class="toc-text">扫描</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E5%92%8C%E5%86%99%E5%85%A5"><span class="toc-number">7.1.2.</span> <span class="toc-text">读取和写入</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">8.</span> <span class="toc-text">漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2017-0785"><span class="toc-number">8.1.</span> <span class="toc-text">CVE-2017-0785</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80-1"><span class="toc-number">8.1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%8C%E6%99%AF%E6%99%AE%E5%8F%8A"><span class="toc-number">8.1.2.</span> <span class="toc-text">背景普及</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SDP%E5%B1%82%E8%AF%A6%E8%A7%A3"><span class="toc-number">8.1.3.</span> <span class="toc-text">SDP层详解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">8.1.4.</span> <span class="toc-text">代码分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%93%E5%8F%96sdp%E5%8C%85"><span class="toc-number">8.1.5.</span> <span class="toc-text">抓取sdp包</span></a></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/&text=蓝牙协议学习"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/&title=蓝牙协议学习"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/&is_video=false&description=蓝牙协议学习"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=蓝牙协议学习&body=Check out this article: http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/&title=蓝牙协议学习"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/&title=蓝牙协议学习"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/&title=蓝牙协议学习"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/&title=蓝牙协议学习"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/&name=蓝牙协议学习&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2023/11/17/%E8%93%9D%E7%89%99%E5%8D%8F%E8%AE%AE%E5%AD%A6%E4%B9%A0/&t=蓝牙协议学习"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022-2024
    C12en
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a href="/categories/">categories</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

    <script type="text/javascript">
        var disqus_shortname = 'c12en';

        (function(){
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        }());
    </script>

<!-- utterances Comments -->

</body>
</html>
